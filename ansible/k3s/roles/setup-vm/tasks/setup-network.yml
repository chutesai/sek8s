---
# Simple Ansible task to fix netplan cloud-init conflict
# Add this to your existing base image build playbook

- name: Remove conflicting netplan configuration for cloud-init compatibility
  ansible.builtin.file:
    path: /etc/netplan/netplan.yaml
    state: absent
  tags: 
    - netplan
    - cloud-init
    - networking

- name: Ensure netplan directory exists with correct permissions
  ansible.builtin.file:
    path: /etc/netplan
    state: directory
    mode: '0755'
    owner: root
    group: root
  tags:
    - netplan
    - cloud-init

- name: Document netplan changes for future reference
  ansible.builtin.copy:
    content: |
      # This file was removed during image build to prevent conflicts with cloud-init
      # Original file: /etc/netplan/netplan.yaml
      # 
      # The original file contained:
      #   network:
      #     version: 2
      #     renderer: networkd
      #     ethernets:
      #       en:
      #         match:
      #           name: "en*"
      #         dhcp4: true
      #         dhcp-identifier: mac
      #
      # This conflicted with cloud-init network configuration.
      # Cloud-init will now create /etc/netplan/50-cloud-init.yaml as needed.
    dest: /etc/netplan/.netplan-removed-for-cloud-init
    mode: '0644'
  tags:
    - netplan
    - documentation