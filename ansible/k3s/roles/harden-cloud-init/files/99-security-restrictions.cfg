# Cloud-init security restrictions configuration
# This file disables dangerous cloud-init modules and only allows safe operations
# Place this file in /etc/cloud/cloud.cfg.d/

# Disable all datasources except NoCloud to prevent metadata service abuse
datasource_list: ['NoCloud']

# Disable dangerous cloud-init modules
cloud_init_modules: []

cloud_config_modules:
  # Only allow hostname setting and file writing
  - set_hostname
  - write-files

cloud_final_modules: []

# Disable all other cloud-init functionality
disable_vmware_customization: true
preserve_hostname: false

# Security settings
ssh_deletekeys: false
ssh_genkeytypes: []

# Disable user creation and management
users: []
default_user: null

# Disable package management
package_update: false
package_upgrade: false
package_reboot_if_required: false

# Disable mount and disk management
mounts: []
disk_setup: {}
fs_setup: []

# Disable network configuration changes
network:
  config: disabled

# Disable repository management
apt:
  preserve_sources_list: true
yum_repos: {}
zypper:
  repos: []

# Disable service management
bootcmd: []
runcmd: []

# Disable phone home and reporting
phone_home: {}
reporting: {}

# Disable configuration management tools
puppet: {}
chef: {}
ansible: {}

# Disable power management
power_state: {}

# Disable swap configuration
swap: {}

# Disable timezone changes
timezone: null

# Disable NTP configuration
ntp: {}

# Disable CA certificate management
ca_certs: {}

# Disable rsyslog configuration
rsyslog: {}

# Disable SSH key management
ssh_keys: {}
ssh_authorized_keys: []

# Disable snap packages
snap: {}

# Disable Ubuntu drivers
ubuntu_drivers: {}

# Disable GRUB configuration
grub_dpkg: {}

# Disable locale settings
locale: null
locale_configfile: null

# Disable keyboard layout
keyboard: {}

# Strict file writing validation
write_files_deferred: false

# System info settings (minimal)
system_info:
  distro: unknown
  default_user: null
  paths:
    cloud_dir: /var/lib/cloud
    run_dir: /run/cloud-init

# Logging configuration for security monitoring
output:
  all: '| tee -a /var/log/cloud-init-security.log'

# Disable cloud-init after first run to prevent re-execution
final_message: |
  TEE TDX VM cloud-init completed securely.
  Only hostname and file writing operations were allowed.
  Cloud-init will be disabled to prevent future modifications.