[Service]
# Filesystem protection
ProtectSystem=strict
ProtectHome=yes
PrivateTmp=no
ReadWritePaths=/var/lib/rancher /var/lib/kubelet /var/lib/cni /run /var/log /cache /etc/rancher/k3s
ReadOnlyPaths=/etc/rancher

# Mount restrictions
PrivateMounts=yes
MountFlags=slave

# Prevent new privileges
NoNewPrivileges=no  # k3s needs this for now, will restrict in containers

# AppArmor profile
AppArmorProfile=k3s-restrictions

# Resource limits (optional)
TasksMax=infinity
LimitNOFILE=1048576
LimitNPROC=infinity

# Additional security
RestrictAddressFamilies=AF_UNIX AF_INET AF_INET6 AF_NETLINK
ProtectKernelTunables=yes
ProtectKernelModules=yes
ProtectControlGroups=yes