---
- name: Get fs-verity measurements for all critical files
  ansible.builtin.command:
    cmd: fsverity measure "{{ item }}"
  loop: "{{ critical_files }}"
  register: file_measurements
  failed_when: false
  changed_when: false

- name: Build measurements data structure
  ansible.builtin.set_fact:
    measurements_data: []

- name: Process measurements results
  ansible.builtin.set_fact:
    measurements_data: "{{ measurements_data + [{'file': item.item, 'measurement': item.stdout.split()[0] if item.rc == 0 else 'FAILED', 'status': 'protected' if item.rc == 0 else 'unprotected'}] }}"
  loop: "{{ file_measurements.results }}"

- name: Calculate measurement statistics
  ansible.builtin.set_fact:
    measured_files: "{{ measurements_data | selectattr('status', 'equalto', 'protected') | list | length }}"
    unmeasured_files: "{{ measurements_data | selectattr('status', 'equalto', 'unprotected') | list | length }}"

- name: Create comprehensive measurements text file
  ansible.builtin.template:
    src: measurements.txt.j2
    dest: /etc/fs-verity-measurements.txt
    owner: root
    group: root
    mode: '0644'

- name: Create comprehensive measurements JSON file
  ansible.builtin.copy:
    content: |
      {
        "timestamp": "{{ ansible_date_time.iso8601 }}",
        "hostname": "{{ ansible_hostname }}",
        "kernel_version": "{{ ansible_kernel }}",
        "total_files": {{ critical_files | length }},
        "protected_files": {{ measured_files }},
        "unprotected_files": {{ unmeasured_files }},
        "measurements": {{ measurements_data | to_nice_json(indent=2) | indent(2) }}
      }
    dest: /etc/fs-verity-measurements.json
    owner: root
    group: root
    mode: '0644'

- name: Run initial fs-verity check to create status file
  ansible.builtin.systemd:
    name: fs-verity-check.service
    state: started
  register: initial_check
  failed_when: false

- name: Display initial check results
  ansible.builtin.debug:
    msg: "Initial fs-verity check completed with status: {{ 'success' if initial_check.failed == false else 'warning/error - check logs' }}"

- name: Verify status file was created
  ansible.builtin.stat:
    path: /var/lib/fs-verity/status.json
  register: status_file

- name: Display measurements summary
  ansible.builtin.debug:
    msg: |
      fs-verity Protection and Monitoring Summary:
      - Total files: {{ critical_files | length }}
      - Protected files: {{ measured_files }}
      - Unprotected files: {{ unmeasured_files }}
      - Measurements saved to: /etc/fs-verity-measurements.txt and /etc/fs-verity-measurements.json
      - Monitoring service: fs-verity-check.timer (every 10 minutes)
      - Status file: {{ '/var/lib/fs-verity/status.json created' if status_file.stat.exists else 'pending creation' }}

- name: Verify measurements files were created
  ansible.builtin.stat:
    path: "{{ item }}"
  loop:
    - /etc/fs-verity-measurements.txt
    - /etc/fs-verity-measurements.json
  register: measurements_files

- name: Confirm measurements files exist
  ansible.builtin.debug:
    msg: "Measurements file {{ item.item }} created successfully ({{ item.stat.size }} bytes)"
  loop: "{{ measurements_files.results }}"
  when: item.stat.exists