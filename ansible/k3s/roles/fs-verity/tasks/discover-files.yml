---
- name: Install critical files discovery script
  ansible.builtin.copy:
    src: discover-critical-files.sh
    dest: /usr/local/bin/discover-critical-files.sh
    owner: root
    group: root
    mode: '0755'

- name: Discover critical files using secure script
  ansible.builtin.command:
    cmd: /usr/local/bin/discover-critical-files.sh
  register: discovered_files_raw
  changed_when: false

- name: Process discovered files list
  ansible.builtin.set_fact:
    critical_files: "{{ discovered_files_raw.stdout_lines | select('match', '^/.+') | list | unique | sort }}"

- name: Display discovered critical files summary
  ansible.builtin.debug:
    msg: "Discovered {{ critical_files | length }} critical files for fs-verity protection using secure discovery script"

- name: Log critical files list (verbose)
  ansible.builtin.debug:
    msg: "{{ critical_files }}"
    verbosity: 1

- name: Verify discovery script will be protected
  ansible.builtin.set_fact:
    critical_files: "{{ critical_files + ['/usr/local/bin/discover-critical-files.sh'] if '/usr/local/bin/discover-critical-files.sh' not in critical_files else critical_files }}"

- name: Final critical files count
  ansible.builtin.debug:
    msg: "Total critical files including discovery script: {{ critical_files | length }}"