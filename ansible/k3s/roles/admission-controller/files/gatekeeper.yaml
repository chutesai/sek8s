---
# Install Gatekeeper via K3s manifest
# This will be placed in /var/lib/rancher/k3s/server/manifests/
apiVersion: v1
kind: Namespace
metadata:
  name: gatekeeper-system

---
# Gatekeeper deployment (minimal version for webhook protection)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gatekeeper-controller
  namespace: gatekeeper-system
spec:
  replicas: 1
  selector:
    matchLabels:
      control-plane: controller-manager
  template:
    metadata:
      labels:
        control-plane: controller-manager
    spec:
      containers:
      - name: manager
        image: openpolicyagent/gatekeeper:v3.14.0
        args:
          - --port=8443
          - --logtostderr
          - --exempt-namespace=gatekeeper-system
          - --operation=webhook
          - --operation=mutation-webhook
          - --disable-opa-builtin=http.send
        ports:
        - containerPort: 8443
          name: webhook
        - containerPort: 8888
          name: metrics
        resources:
          limits:
            memory: 512Mi
            cpu: 1000m
          requests:
            memory: 256Mi
            cpu: 100m
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
          readOnlyRootFilesystem: true
          runAsNonRoot: true
          runAsUser: 1000
          seccompProfile:
            type: RuntimeDefault
      nodeSelector:
        kubernetes.io/os: linux
      priorityClassName: system-cluster-critical
      serviceAccountName: gatekeeper-admin

---
# ServiceAccount for Gatekeeper
apiVersion: v1
kind: ServiceAccount
metadata:
  name: gatekeeper-admin
  namespace: gatekeeper-system

---
# ClusterRole for Gatekeeper
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: gatekeeper-manager-role
rules:
- apiGroups: ["*"]
  resources: ["*"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["templates.gatekeeper.sh", "constraints.gatekeeper.sh"]
  resources: ["*"]
  verbs: ["*"]

---
# ClusterRoleBinding for Gatekeeper
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: gatekeeper-manager-rolebinding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: gatekeeper-manager-role
subjects:
- kind: ServiceAccount
  name: gatekeeper-admin
  namespace: gatekeeper-system

---
# Service for Gatekeeper webhook
apiVersion: v1
kind: Service
metadata:
  name: gatekeeper-webhook-service
  namespace: gatekeeper-system
spec:
  ports:
  - port: 443
    targetPort: 8443
  selector:
    control-plane: controller-manager

---
# ValidatingWebhookConfiguration for Gatekeeper
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingWebhookConfiguration
metadata:
  name: gatekeeper-validating-webhook-configuration
webhooks:
- name: validation.gatekeeper.sh
  clientConfig:
    service:
      name: gatekeeper-webhook-service
      namespace: gatekeeper-system
      path: "/validate"
  rules:
  - apiGroups: ["*"]
    apiVersions: ["*"]
    resources: ["*"]
    operations: ["CREATE", "UPDATE", "DELETE"]
  namespaceSelector:
    matchExpressions:
    - key: kubernetes.io/metadata.name
      operator: NotIn
      values:
      - gatekeeper-system
      - kube-system
      - kube-public
      - kube-node-lease
  failurePolicy: Fail
  admissionReviewVersions: ["v1", "v1beta1"]
  sideEffects: None