- name: Install system dependencies for Python and Git
  ansible.builtin.apt:
    name:
      - python3
      - python3-pip
      - python3-venv
      - python3-dev
      - git
      - build-essential
      - curl
    state: present
    update_cache: yes

- name: Create admission controller user
  ansible.builtin.user:
    name: admission
    system: yes
    shell: /bin/false
    home: /opt/admission-controller
    create_home: yes

- name: Install Poetry system-wide
  ansible.builtin.shell: |
    curl -sSL https://install.python-poetry.org | python3 -
  args:
    creates: /root/.local/bin/poetry
  environment:
    POETRY_HOME: /opt/poetry
    
- name: Add Poetry to system PATH
  ansible.builtin.lineinfile:
    path: /etc/environment
    regexp: '^PATH='
    line: 'PATH="/opt/poetry/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"'

- name: Create symlink for Poetry in /usr/local/bin
  ansible.builtin.file:
    src: /opt/poetry/bin/poetry
    dest: /usr/local/bin/poetry
    state: link

- name: Check if repository already exists
  ansible.builtin.stat:
    path: /opt/admission-controller/.git
  register: repo_exists

- name: Clone admission controller repository
  ansible.builtin.git:
    repo: "{{ admission_controller_repo | default('https://github.com/your-org/k3s-admission-controller.git') }}"
    dest: /opt/admission-controller
    version: "{{ admission_controller_version | default('main') }}"
    force: no
  when: not repo_exists.stat.exists

- name: Update repository if it exists
  ansible.builtin.git:
    repo: "{{ admission_controller_repo | default('https://github.com/your-org/k3s-admission-controller.git') }}"
    dest: /opt/admission-controller
    version: "{{ admission_controller_version | default('main') }}"
    update: yes
  when: repo_exists.stat.exists and update_repository | default(true)

- name: Set ownership of admission controller directory
  ansible.builtin.file:
    path: /opt/admission-controller
    owner: admission
    group: admission
    recurse: yes

- name: Configure Poetry to create virtualenv in project
  ansible.builtin.command:
    cmd: poetry config virtualenvs.in-project true
  become: yes
  become_user: admission
  args:
    chdir: /opt/admission-controller

- name: Install Python dependencies with Poetry
  ansible.builtin.command:
    cmd: poetry install --no-interaction --no-ansi
  become: yes
  become_user: admission
  args:
    chdir: /opt/admission-controller
    creates: /opt/admission-controller/.venv

- name: Update dependencies if lock file changed
  ansible.builtin.command:
    cmd: poetry update --no-interaction --no-ansi
  become: yes
  become_user: admission
  args:
    chdir: /opt/admission-controller
  when: update_dependencies | default(false)

- name: Create required directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ item.owner | default('admission') }}"
    group: "{{ item.group | default('admission') }}"
    mode: "{{ item.mode | default('0755') }}"
  loop:
    - { path: /etc/admission-controller, owner: root, mode: '0755' }
    - { path: /etc/admission-controller/certs, owner: root, group: admission, mode: '0750' }
    - { path: /var/log/admission-controller, owner: admission }
    - { path: /run/admission-controller, owner: admission }

- name: Create admission controller configuration
  ansible.builtin.template:
    src: admission-config.json.j2
    dest: /etc/admission-controller/config.json
    owner: root
    group: admission
    mode: '0640'

- name: Create .env file for admission controller
  ansible.builtin.template:
    src: admission-controller.env.j2
    dest: /opt/admission-controller/.env
    owner: admission
    group: admission
    mode: '0600'