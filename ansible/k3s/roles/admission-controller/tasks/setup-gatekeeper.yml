---
- name: Setup Gatekeeper for webhook protection
  block:
    - name: Deploy Gatekeeper system
      ansible.builtin.template:
        src: gatekeeper.yaml
        dest: /var/lib/rancher/k3s/server/manifests/gatekeeper.yaml
        owner: root
        group: root
        mode: '0600'
      notify: restart k3s

    - name: Wait for Gatekeeper to be ready
      ansible.builtin.shell: |
        kubectl wait --for=condition=Ready pod -l control-plane=controller-manager \
          -n gatekeeper-system --timeout=300s --kubeconfig=/etc/rancher/k3s/k3s.yaml
      register: gatekeeper_ready
      retries: 10
      delay: 30
      until: gatekeeper_ready.rc == 0

    - name: Deploy Gatekeeper protection policies
      ansible.builtin.template:
        src: gatekeeper-policies.yaml
        dest: /var/lib/rancher/k3s/server/manifests/gatekeeper-policies.yaml
        owner: root
        group: root
        mode: '0600'

    - name: Protect Gatekeeper manifests with immutable flag
      ansible.builtin.file:
        path: "{{ item }}"
        owner: root
        group: root
        mode: '0400'
        attributes: '+i'
      loop:
        - /var/lib/rancher/k3s/server/manifests/gatekeeper-install.yaml
        - /var/lib/rancher/k3s/server/manifests/gatekeeper-policies.yaml

    - name: Add Gatekeeper manifests to attestation
      ansible.builtin.lineinfile:
        path: /etc/security/integrity/monitored-files.txt
        line: "{{ item }}"
      loop:
        - /var/lib/rancher/k3s/server/manifests/gatekeeper-install.yaml
        - /var/lib/rancher/k3s/server/manifests/gatekeeper-policies.yaml

    - name: Generate Gatekeeper manifest hashes
      ansible.builtin.shell: |
        sha256sum /var/lib/rancher/k3s/server/manifests/gatekeeper*.yaml > \
          /etc/security/integrity/gatekeeper-manifests.sha256
      args:
        creates: /etc/security/integrity/gatekeeper-manifests.sha256