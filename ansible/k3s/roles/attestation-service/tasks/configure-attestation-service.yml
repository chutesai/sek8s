---
- name: Configure attestation service
  block:
    - name: Create attestation systemd service
      ansible.builtin.copy:
        src: attestation-service.service
        dest: /etc/systemd/system/attestation-service.service
        owner: root
        group: root
        mode: '0644'

    - name: Create attestation service override directory
      ansible.builtin.file:
        path: /etc/systemd/system/attestation-service.service.d
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Create security hardening drop-in
      ansible.builtin.copy:
        src: attestation-service.conf
        dest: /etc/systemd/system/attestation-service.service.d/10-security.conf
        owner: root
        group: root
        mode: '0644'

    - name: Generate private key for attestation service test
      ansible.builtin.command:
        cmd: openssl genrsa -out /etc/attestation-service/certs/server.key 2048
        creates: /etc/attestation-service/certs/server.key

    - name: Generate self-signed certificate for attestation service  test
      ansible.builtin.command:
        cmd: >
          openssl req -x509 -new -nodes -key /etc/attestation-service/certs/server.key
          -sha256 -days 1 -out /etc/attestation-service/certs/server.crt
          -subj "/CN=attestation-service"
        creates: /etc/attestation-service/certs/server.crt

    - name: Set certificate permissions
      ansible.builtin.file:
        path: "{{ item }}"
        owner: tdx-attest
        group: tdx-attest
        mode: '0640'
      loop:
        - /etc/attestation-service/certs/server.key
        - /etc/attestation-service/certs/server.crt

    - name: Reload systemd and start attestation
      ansible.builtin.systemd:
        name: attestation-service
        daemon_reload: yes
        
        enabled: yes
        state: started

    - name: Wait for attestation to be ready
      ansible.builtin.uri:
        url: http://localhost/health
        unix_socket: /run/attestation-service/attestation.sock
        status_code: 200
      register: attestation_health
      until: attestation_health.status == 200
      retries: 30
      delay: 2

    - name: Stop attestation service
      ansible.builtin.systemd:
        name: attestation-service
        state: stopped

    - name: Remove temporary certificates
      ansible.builtin.file:
        path: /etc/attestation-service/certs
        state: absent