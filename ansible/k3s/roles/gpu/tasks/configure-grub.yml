- name: Backup original GRUB config
  copy:
    src: /etc/default/grub
    dest: /etc/default/grub.bak
    remote_src: yes
  tags: backup

- name: Append hugepages configuration to GRUB
  lineinfile:
    path: /etc/default/grub
    line: 'GRUB_CMDLINE_LINUX="$GRUB_CMDLINE_LINUX hugepagesz={{ hugepage_size }} hugepages={{ hugepage_count }}"'
    state: present
  register: grub_config
  tags: grub

- name: Update GRUB bootloader
  command: update-grub
  when: grub_config.changed
  tags: grub

- name: Verify hugepages will be allocated (dry-run)
  command: grep -q "hugepages={{ hugepage_count }}" /etc/default/grub
  register: hugepages_check
  failed_when: hugepages_check.rc != 0
  tags: verify

# - name: Reboot VM to apply hugepages (required)
#   reboot:
#     reboot_timeout: 600
#     connect_timeout: 30
#     pre_reboot_delay: 10
#     post_reboot_delay: 60
#     msg: "Rebooting to activate 1G huge pages..."
#   when: grub_config.changed
#   tags: reboot

# - name: Wait for VM to come back online
#   wait_for_connection:
#     delay: 30
#     timeout: 300
#   when: grub_config.changed
#   tags: wait

# - name: Confirm hugepages are active
#   shell: |
#     set -e
#     echo "HugePages_Total: $(cat /proc/meminfo | grep HugePages_Total | awk '{print $2}')"
#     echo "Hugepagesize:     $(cat /proc/meminfo | grep Hugepagesize | awk '{print $2 $3}')"
#   register: hugepages_status
#   changed_when: false
#   tags: verify

# - name: Display hugepages status
#   debug:
#     msg: |
#       Huge Pages Configured:
#       {{ hugepages_status.stdout_lines | join('\n          ') }}
#   tags: verify