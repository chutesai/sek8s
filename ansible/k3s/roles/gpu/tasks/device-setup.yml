---
- name: Check CUDA
  tags:
    - gpu-device-setup
  block:
    - name: Check CUDA installation
      ansible.builtin.apt:
        name: cuda-toolkit-{{ cuda_version }}
        state: present
      check_mode: true
      register: cuda_check
      ignore_errors: true

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
      environment:
        DEBIAN_FRONTEND: noninteractive
        NEEDRESTART_SUSPEND: "y"

    - name: Get list of installed CUDA/NVIDIA packages
      ansible.builtin.shell:
        cmd: |
          set -o pipefail
          dpkg --list | egrep -i 'cuda|nvidia' | grep -v 'linux-nvidia' | awk '{print $2}' || true
        executable: /bin/bash
      register: nvidia_packages
      changed_when: false

    - name: Remove old CUDA/NVIDIA packages
      ansible.builtin.apt:
        name: "{{ nvidia_packages.stdout_lines }}"
        state: absent
        allow_change_held_packages: true
      when:
        - not skip_cuda | bool
        - (cuda_check.failed or cuda_check.changed)
        - nvidia_packages.stdout_lines | length > 0
      environment:
        DEBIAN_FRONTEND: noninteractive
        NEEDRESTART_SUSPEND: "y"

    - name: Purge old CUDA/NVIDIA packages
      ansible.builtin.command: dpkg --purge {{ item }}
      loop: "{{ nvidia_packages.stdout_lines }}"
      when:
        - not skip_cuda | bool
        - (cuda_check.failed or cuda_check.changed)
        - nvidia_packages.stdout_lines | length > 0
      failed_when: false
      changed_when: true

    # Adding this help mitigate lock conflicts when installing cuda keyring
    - name: Package environment cleanup
      block:
        - name: Check what's holding the dpkg lock
          shell: lsof /var/lib/dpkg/lock* 2>/dev/null || echo "No active locks"
          register: lock_holders
          changed_when: false

        - name: Display lock holders
          debug:
            var: lock_holders.stdout_lines

        - name: Wait for any existing package operations to complete
          shell: |
            timeout=300  # 5 minutes
            while [ $timeout -gt 0 ] && fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1; do
              echo "Waiting for package lock to be released... ($timeout seconds remaining)"
              sleep 10
              timeout=$((timeout - 10))
            done
            if [ $timeout -le 0 ]; then
              echo "Timeout waiting for package lock"
              exit 1
            fi
          changed_when: false

    - name: Download and install CUDA keyring
      block:
        - name: Download keyring
          ansible.builtin.get_url:
            url: https://developer.download.nvidia.com/compute/cuda/repos/ubuntu{{ ubuntu_major }}{{ ubuntu_minor }}/x86_64/cuda-keyring_1.1-1_all.deb
            dest: /tmp/cuda-keyring.deb
            mode: "0644"
            owner: root
            group: root

        - name: Install keyring
          ansible.builtin.apt:
            deb: /tmp/cuda-keyring.deb

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true

    - name: GPU Setup Tasks
      when: not skip_cuda | bool
      block:
        - name: Install CUDA toolkit
          ansible.builtin.apt:
            name: cuda-toolkit-{{ cuda_version }}
            state: present

        - name: Install NVIDIA 580 driver packages
          ansible.builtin.apt:
            name:
              - libnvidia-cfg1-580=580.82.07-0ubuntu1
              - libnvidia-common-580=580.82.07-0ubuntu1
              - libnvidia-compute-580=580.82.07-0ubuntu1
              - libnvidia-decode-580=580.82.07-0ubuntu1
              - libnvidia-encode-580=580.82.07-0ubuntu1
              - libnvidia-extra-580=580.82.07-0ubuntu1
              - libnvidia-fbc1-580=580.82.07-0ubuntu1
              - libnvidia-gl-580=580.82.07-0ubuntu1
              - libnvidia-gpucomp-580=580.82.07-0ubuntu1
              - nvidia-dkms-580-open=580.82.07-0ubuntu1
              - nvidia-driver-580-open=580.82.07-0ubuntu1
              - nvidia-firmware-580=580.82.07-0ubuntu1
              - nvidia-kernel-common-580=580.82.07-0ubuntu1
              - nvidia-kernel-source-580-open=580.82.07-0ubuntu1
              - nvidia-modprobe=580.82.07-0ubuntu1
              - nvidia-open-580=580.82.07-0ubuntu1
              - nvidia-persistenced=580.82.07-0ubuntu1
              - nvidia-settings=580.82.07-0ubuntu1
              - nvidia-utils-580=580.82.07-0ubuntu1
              - xserver-xorg-video-nvidia-580=580.82.07-0ubuntu1
            state: present
          register: driver_install
          changed_when: driver_install.changed

        - name: Download Fabric Manager 580
          ansible.builtin.get_url:
            url: http://archive.ubuntu.com/ubuntu/pool/multiverse/f/fabric-manager-580/nvidia-fabricmanager-580_580.82.07-0ubuntu1_amd64.deb
            dest: /tmp/nvidia-fabricmanager-580.deb
            mode: "0644"

        - name: Install Fabric Manager 580
          ansible.builtin.apt:
            deb: /tmp/nvidia-fabricmanager-580.deb

        - name: Install NVIDIA Container Toolkit
          ansible.builtin.apt:
            name: nvidia-container-toolkit
            state: present
            update_cache: true

        - name: Configure NVIDIA Fabric Manager
          ansible.builtin.systemd:
            name: nvidia-fabricmanager
            enabled: true
            masked: false

    - name: Configure file limits
      ansible.builtin.blockinfile:
        path: /etc/security/limits.conf
        block: |
          * soft nofile 40000
          * hard nofile 40001

    - name: Configure PAM limits
      ansible.builtin.lineinfile:
        path: "{{ item }}"
        line: "session required pam_limits.so"
      with_items:
        - /etc/pam.d/common-session
        - /etc/pam.d/common-session-noninteractive

- name: Blacklist nvidia-drm module
  ansible.builtin.copy:
    dest: /etc/modprobe.d/blacklist-nvidia-drm.conf
    content: |
      # Blacklist nvidia-drm for compute-only GPUs
      blacklist nvidia-drm
    mode: '0644'
    owner: root
    group: root
  notify: update initramfs
  register: nvidia_drm_blacklist

- name: Add NVIDIA LKCA preload drop-in
  copy:
    dest: /etc/modprobe.d/nvidia-lkca.conf
    owner: root
    group: root
    mode: '0644'
    content: |
      # Ensures ECDSA/ECDH crypto modules load before nvidia.ko
      install nvidia /sbin/modprobe ecdsa_generic; /sbin/modprobe ecdh; /sbin/modprobe --ignore-install nvidia
  notify: update initramfs
